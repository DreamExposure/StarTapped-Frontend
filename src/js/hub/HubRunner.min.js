let timeIndex=new TimeIndex,keepChecking=!0,isGenerating=!1,blogIcons=new Map;function doLoadHub(){initOnHub(),getPostsFromServer(),getBlogsFromServerForSelection(),handleTypeChange(null)}function showPosts(e){if(isGenerating=!0,e.count<=0)keepChecking=!1,showSnackbar("No most posts!");else{e.range.latest>0&&(timeIndex.latest=e.range.latest,timeIndex.oldest=e.range.oldest);let t=[];for(let o=0;o<e.count;o++)t.push((new Post).fromJson(e.posts[o]));t.sort(function(e,t){return new Date(t.timestamp)-new Date(e.timestamp)});let o=document.getElementById("post-container");for(let e=0;e<t.length;e++){let a=t[e];if(a.timestamp>=timeIndex.oldest&&a.timestamp<=timeIndex.latest)if("Unassigned"!==a.parent)o.appendChild(generatePostTree(a,t));else{let e=null;"TEXT"===a.postType?e=generateTextPost(a,null,!0,!0,!0):"IMAGE"===a.postType?e=generateImagePost(a,null,!0,!0,!0):"AUDIO"===a.postType?e=generateAudioPost(a,null,!0,!0,!0):"VIDEO"===a.postType&&(e=generateVideoPost(a,null,!0,!0,!0)),null!=e&&o.appendChild(e)}}}timeIndex.before=timeIndex.oldest-1,isGenerating=!1}function getPostsFromServer(){if(!isGenerating&&keepChecking){let e={before:timeIndex.before,limit:20};$.ajax({url:"https://api.startapped.com/v1/post/get/hub",headers:{"Content-Type":"application/json",Authorization_Access:getCredentials().access,Authorization_Refresh:getCredentials().refresh},method:"POST",dataType:"json",data:JSON.stringify(e),success:function(e){showPosts(e)},error:function(e,t,o){showSnackbar(JSON.parse(e.responseText).message)}})}}function getBlogsFromServerForSelection(){$.ajax({url:"https://api.startapped.com/v1/blog/get",headers:{"Content-Type":"application/json",Authorization_Access:getCredentials().access,Authorization_Refresh:getCredentials().refresh},method:"POST",dataType:"json",data:JSON.stringify({all:!0}),success:function(e){let t=document.getElementById("create-post-blog-select");for(let o=0;o<e.count;o++){let a=(new Blog).fromJson(e.blogs[o]);blogIcons.set(a.id,a.iconImage.url);let n=document.createElement("option");n.value=a.id,n.innerText=a.baseUrl,t.appendChild(n)}document.getElementById("create-post-blog-icon").src=blogIcons.get(t.options[t.selectedIndex].value)},error:function(e,t,o){showSnackbar(JSON.parse(e.responseText).message)}})}function onBlogSelectChange(){let e=document.getElementById("create-post-blog-select");document.getElementById("create-post-blog-icon").src=blogIcons.get(e.options[e.selectedIndex].value)}function createNewPost(){let e=document.getElementById("create-post-blog-select"),t=[],o=document.getElementById("create-post-tags").value.split(",");for(let e=0;e<o.length;e++){let a=o[e].trim();a.length>0&&t.push(a)}let a={blog_id:e.options[e.selectedIndex].value,type:getPostTypeForCreate(null),title:document.getElementById("create-post-title").value,body:document.getElementById("create-post-body").value,tags:t,nsfw:!1};if(hasEncodedResults("post-create-media")){let e=getEncodedResults("post-create-media");switch(getPostTypeForCreate(null)){case"IMAGE":a.image=e;break;case"AUDIO":a.audio=e;break;case"VIDEO":a.video=e}}else switch(getPostTypeForCreate(null)){case"IMAGE":return void showSnackbar("Image posts must have an image.");case"AUDIO":showSnackbar("Audio posts must have an audio file.");break;case"VIDEO":showSnackbar("Video posts must have a video.")}showLoading(),$.ajax({url:"https://api.startapped.com/v1/post/create",headers:{"Content-Type":"application/json",Authorization_Access:getCredentials().access,Authorization_Refresh:getCredentials().refresh},method:"POST",dataType:"json",data:JSON.stringify(a),success:function(e){hideLoading(),$("#modal-post-create").modal("hide"),showSnackbar("Success!"),resetPostTypeForCreate(),handleTypeChange(null),document.getElementById("create-post-title").value="",document.getElementById("create-post-body").value="",document.getElementById("create-post-tags").value="",removeEncodedResults("post-create-media")},error:function(e,t,o){hideLoading(),showSnackbar(JSON.parse(e.responseText).message)}})}function handleTypeChange(e){let t=document.getElementById("post-create-image-label"),o=document.getElementById("post-create-audio-label"),a=document.getElementById("post-create-video-label"),n=document.getElementById("post-create-image-file"),s=document.getElementById("post-create-audio-file"),l=document.getElementById("post-create-video-file");switch(n.value="",s.value="",l.value="",removeEncodedResults("post-create-media"),getPostTypeForCreate(e)){case"TEXT":t.hidden=!0,o.hidden=!0,a.hidden=!0;break;case"IMAGE":t.hidden=!1,o.hidden=!0,a.hidden=!0;break;case"AUDIO":t.hidden=!0,o.hidden=!1,a.hidden=!0;break;case"VIDEO":t.hidden=!0,o.hidden=!0,a.hidden=!1}}function getPostTypeForCreate(e){return null===e?$("#text-option-label").hasClass("active")?"TEXT":$("#image-option-label").hasClass("active")?"IMAGE":$("#audio-option-label").hasClass("active")?"AUDIO":$("#video-option-label").hasClass("active")?"VIDEO":"TEXT":"text-option-label"===e.id?"TEXT":"image-option-label"===e.id?"IMAGE":"audio-option-label"===e.id?"AUDIO":"video-option-label"===e.id?"VIDEO":"TEXT"}function resetPostTypeForCreate(){$("#text-option-label").removeClass("active"),$("#image-option-label").removeClass("active"),$("#audio-option-label").removeClass("active"),$("#video-option-label").removeClass("active");let e=document.getElementById("post-create-image-file"),t=document.getElementById("post-create-audio-file"),o=document.getElementById("post-create-video-file");e.value="",t.value="",o.value="",removeEncodedResults("post-create-media")}window.onscroll=function(){window.innerHeight+window.scrollY>=document.body.scrollHeight&&getPostsFromServer()};